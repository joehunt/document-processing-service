<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Processing Service</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
        }
        input, textarea, select, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .file-input {
            margin-bottom: 10px;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .artifacts-list, .templates-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        .artifact-item, .template-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .artifact-item:hover, .template-item:hover {
            background-color: #f0f0f0;
        }
        .selected {
            background-color: #e3f2fd;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }
        .json-input {
            font-family: monospace;
            min-height: 150px;
        }
    </style>
</head>
<body>
    <h1>Document Processing Service</h1>

    <!-- Upload Section -->
    <div class="container">
        <h2>1. Upload Document</h2>
        <div class="form-group">
            <label for="fileInput">Select Document:</label>
            <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls,.rtf,.odt,.ods,.ppt,.pptx">
        </div>
        <button onclick="uploadFile()">Upload Document</button>
        <div id="uploadResult" class="result" style="display: none;"></div>
        
        <h3>Uploaded Artifacts</h3>
        <button onclick="loadArtifacts()">Refresh Artifacts</button>
        <div id="artifactsList" class="artifacts-list"></div>
    </div>

    <!-- Templates Section -->
    <div class="container">
        <h2>2. Manage Processing Templates</h2>
        
        <h3 id="templateFormTitle">Create New Template</h3>
        <div class="form-group">
            <label for="templateName">Template Name:</label>
            <input type="text" id="templateName" placeholder="e.g., Invoice Extractor">
        </div>
        <div class="form-group">
            <label for="templateDescription">Description:</label>
            <input type="text" id="templateDescription" placeholder="Brief description of what this template extracts">
        </div>
        <div class="form-group">
            <label for="systemPrompt">System Prompt:</label>
            <textarea id="systemPrompt" placeholder="You are an expert at extracting structured data from documents..."></textarea>
        </div>
        <div class="form-group">
            <label for="userPromptTemplate">User Prompt Template:</label>
            <textarea id="userPromptTemplate" placeholder="Extract the following information from this document:\n\n{document}"></textarea>
        </div>
        <div class="form-group">
            <label for="jsonSchema">JSON Schema:</label>
            <textarea id="jsonSchema" class="json-input" placeholder='{"type": "object", "properties": {"field1": {"type": "string"}}, "required": ["field1"]}'></textarea>
        </div>
        <div class="form-group">
            <label for="preferredFormat">Preferred Format:</label>
            <select id="preferredFormat">
                <option value="text">Text</option>
                <option value="pdf">PDF</option>
                <option value="csv">CSV</option>
                <option value="html">HTML</option>
            </select>
        </div>
        <div id="templateButtons">
            <button id="createTemplateBtn" onclick="createTemplate()">Create Template</button>
            <button id="updateTemplateBtn" onclick="updateTemplate()" style="display: none;">Update Template</button>
            <button id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
        </div>
        <div id="templateResult" class="result" style="display: none;"></div>

        <h3>Existing Templates</h3>
        <button onclick="loadTemplates()">Refresh Templates</button>
        <div id="templatesList" class="templates-list"></div>
    </div>

    <!-- Document Conversion Section -->
    <div class="container">
        <h2>3. Convert Documents</h2>
        <div class="form-group">
            <label>Selected Artifact:</label>
            <div id="conversionArtifact" style="padding: 10px; background: #f0f0f0; border-radius: 4px;">No artifact selected</div>
        </div>
        <div class="form-group">
            <label for="conversionFormat">Convert to Format:</label>
            <select id="conversionFormat">
                <option value="txt">Text (.txt)</option>
                <option value="pdf">PDF (.pdf)</option>
                <option value="csv">CSV (.csv)</option>
                <option value="html">HTML (.html)</option>
            </select>
        </div>
        <button onclick="convertDocument()" id="convertButton" disabled>Convert Document</button>
        <div id="conversionResult" class="result" style="display: none;"></div>
    </div>

    <!-- Extraction Section -->
    <div class="container">
        <h2>4. Extract Data</h2>
        <div class="form-group">
            <label>Selected Artifact:</label>
            <div id="selectedArtifact" style="padding: 10px; background: #f0f0f0; border-radius: 4px;">No artifact selected</div>
        </div>
        <div class="form-group">
            <label>Selected Template:</label>
            <div id="selectedTemplate" style="padding: 10px; background: #f0f0f0; border-radius: 4px;">No template selected</div>
        </div>
        <button onclick="extractData()" id="extractButton" disabled>Extract Data</button>
        <div id="extractionResult" class="result" style="display: none;"></div>
    </div>

    <!-- Saved Extractions Section -->
    <div class="container">
        <h2>5. Saved Extractions</h2>
        <button onclick="loadExtractions()">Refresh Extractions</button>
        <div id="extractionsList" class="extractions-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px;"></div>
    </div>

    <script>
        let selectedArtifactId = null;
        let selectedTemplateId = null;

        // Upload file
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('uploadResult', 'Please select a file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/artifacts/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('uploadResult', `File uploaded successfully!\nArtifact ID: ${result.id}\nFilename: ${result.filename}\nSize: ${result.file_size} bytes`, 'success');
                    loadArtifacts();
                } else {
                    showResult('uploadResult', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showResult('uploadResult', `Error: ${error.message}`, 'error');
            }
        }

        // Load artifacts
        async function loadArtifacts() {
            try {
                const response = await fetch('/artifacts');
                const artifacts = await response.json();
                
                const listDiv = document.getElementById('artifactsList');
                if (artifacts.length === 0) {
                    listDiv.innerHTML = '<p>No artifacts found</p>';
                    return;
                }

                listDiv.innerHTML = artifacts.map(artifact => 
                    `<div class="artifact-item" onclick="selectArtifact('${artifact.id}', '${artifact.original_filename}')" data-id="${artifact.id}">
                        <strong>${artifact.original_filename}</strong><br>
                        ID: ${artifact.id}<br>
                        Size: ${artifact.file_size} bytes<br>
                        Type: ${artifact.mime_type}<br>
                        Created: ${new Date(artifact.created_at).toLocaleString()}
                    </div>`
                ).join('');
            } catch (error) {
                document.getElementById('artifactsList').innerHTML = `<p>Error loading artifacts: ${error.message}</p>`;
            }
        }

        // Select artifact
        function selectArtifact(id, filename) {
            selectedArtifactId = id;
            document.getElementById('selectedArtifact').textContent = `${filename} (${id})`;
            document.getElementById('conversionArtifact').textContent = `${filename} (${id})`;
            
            // Update UI
            document.querySelectorAll('.artifact-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-id="${id}"]`).classList.add('selected');
            
            updateExtractButton();
            updateConvertButton();
        }

        // Create template
        async function createTemplate() {
            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;
            const systemPrompt = document.getElementById('systemPrompt').value;
            const userPromptTemplate = document.getElementById('userPromptTemplate').value;
            const jsonSchemaText = document.getElementById('jsonSchema').value;
            const preferredFormat = document.getElementById('preferredFormat').value;

            if (!name || !systemPrompt || !userPromptTemplate || !jsonSchemaText) {
                showResult('templateResult', 'Please fill in all required fields', 'error');
                return;
            }

            let jsonSchema;
            try {
                jsonSchema = JSON.parse(jsonSchemaText);
            } catch (error) {
                showResult('templateResult', 'Invalid JSON schema: ' + error.message, 'error');
                return;
            }

            const templateData = {
                name,
                description,
                system_prompt: systemPrompt,
                user_prompt_template: userPromptTemplate,
                json_schema: jsonSchema,
                preferred_format: preferredFormat
            };

            try {
                const response = await fetch('/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('templateResult', `Template created successfully!\nTemplate ID: ${result.id}\nName: ${result.name}`, 'success');
                    loadTemplates();
                    // Clear form
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateDescription').value = '';
                    document.getElementById('systemPrompt').value = '';
                    document.getElementById('userPromptTemplate').value = '';
                    document.getElementById('jsonSchema').value = '';
                } else {
                    showResult('templateResult', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showResult('templateResult', `Error: ${error.message}`, 'error');
            }
        }

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch('/templates');
                const templates = await response.json();
                
                const listDiv = document.getElementById('templatesList');
                if (templates.length === 0) {
                    listDiv.innerHTML = '<p>No templates found</p>';
                    return;
                }

                listDiv.innerHTML = templates.map(template => 
                    `<div class="template-item" data-id="${template.id}">
                        <div onclick="selectTemplate('${template.id}', '${template.name}')" style="cursor: pointer; flex-grow: 1;">
                            <strong>${template.name}</strong><br>
                            ${template.description}<br>
                            Format: ${template.preferred_format}<br>
                            Created: ${new Date(template.created_at).toLocaleString()}
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button onclick="editTemplate('${template.id}')" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Edit</button>
                            <button onclick="deleteTemplate('${template.id}')" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                        </div>
                    </div>`
                ).join('');
            } catch (error) {
                document.getElementById('templatesList').innerHTML = `<p>Error loading templates: ${error.message}</p>`;
            }
        }

        // Select template
        function selectTemplate(id, name) {
            selectedTemplateId = id;
            document.getElementById('selectedTemplate').textContent = `${name} (${id})`;
            
            // Update UI
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-id="${id}"]`).classList.add('selected');
            
            updateExtractButton();
        }

        // Update extract button state
        function updateExtractButton() {
            const button = document.getElementById('extractButton');
            button.disabled = !selectedArtifactId || !selectedTemplateId;
        }

        // Extract data
        async function extractData() {
            if (!selectedArtifactId || !selectedTemplateId) {
                showResult('extractionResult', 'Please select both an artifact and a template', 'error');
                return;
            }

            const extractButton = document.getElementById('extractButton');
            extractButton.disabled = true;
            extractButton.textContent = 'Extracting...';

            try {
                const response = await fetch(`/artifacts/${selectedArtifactId}/extract`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        template_id: selectedTemplateId
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.success) {
                        showResult('extractionResult', 
                            `Extraction completed successfully!\n\nExtracted Data:\n${JSON.stringify(result.extracted_data, null, 2)}\n\nModel: ${result.llm_model}\nProcessing Time: ${result.processing_time_seconds}s`, 
                            'success');
                    } else {
                        showResult('extractionResult', `Extraction failed: ${result.error_message}`, 'error');
                    }
                } else {
                    showResult('extractionResult', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showResult('extractionResult', `Error: ${error.message}`, 'error');
            } finally {
                extractButton.disabled = false;
                extractButton.textContent = 'Extract Data';
                updateExtractButton();
            }
        }

        // Utility function to show results
        function showResult(elementId, message, type) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        // Document conversion functionality
        // Update convert button state
        function updateConvertButton() {
            const button = document.getElementById('convertButton');
            button.disabled = !selectedArtifactId;
        }

        // Convert document
        async function convertDocument() {
            if (!selectedArtifactId) {
                showResult('conversionResult', 'Please select an artifact to convert', 'error');
                return;
            }

            const format = document.getElementById('conversionFormat').value;
            const convertButton = document.getElementById('convertButton');
            
            convertButton.disabled = true;
            convertButton.textContent = 'Converting...';

            try {
                const response = await fetch(`/artifacts/${selectedArtifactId}/convert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: format
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.success) {
                        showResult('conversionResult', 
                            `Document converted successfully!\n\nFormat: ${result.format}\nOutput Path: ${result.file_path}\nFile Size: ${result.file_size} bytes`, 
                            'success');
                    } else {
                        showResult('conversionResult', `Conversion failed: ${result.error_message}`, 'error');
                    }
                } else {
                    showResult('conversionResult', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showResult('conversionResult', `Error: ${error.message}`, 'error');
            } finally {
                convertButton.disabled = false;
                convertButton.textContent = 'Convert Document';
                updateConvertButton();
            }
        }

        // Template editing functionality
        let editingTemplateId = null;

        // Edit template
        async function editTemplate(templateId) {
            try {
                const response = await fetch(`/templates/${templateId}`);
                const template = await response.json();
                
                if (response.ok) {
                    // Populate form with template data
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('templateDescription').value = template.description;
                    document.getElementById('systemPrompt').value = template.system_prompt;
                    document.getElementById('userPromptTemplate').value = template.user_prompt_template;
                    document.getElementById('jsonSchema').value = JSON.stringify(template.json_schema, null, 2);
                    document.getElementById('preferredFormat').value = template.preferred_format;
                    
                    // Switch to edit mode
                    editingTemplateId = templateId;
                    document.getElementById('templateFormTitle').textContent = `Edit Template: ${template.name}`;
                    document.getElementById('createTemplateBtn').style.display = 'none';
                    document.getElementById('updateTemplateBtn').style.display = 'inline';
                    document.getElementById('cancelEditBtn').style.display = 'inline';
                    
                    // Scroll to form
                    document.getElementById('templateFormTitle').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showResult('templateResult', `Error loading template: ${template.detail}`, 'error');
                }
            } catch (error) {
                showResult('templateResult', `Error: ${error.message}`, 'error');
            }
        }

        // Update template
        async function updateTemplate() {
            if (!editingTemplateId) return;

            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;
            const systemPrompt = document.getElementById('systemPrompt').value;
            const userPromptTemplate = document.getElementById('userPromptTemplate').value;
            const jsonSchemaText = document.getElementById('jsonSchema').value;
            const preferredFormat = document.getElementById('preferredFormat').value;

            if (!name || !systemPrompt || !userPromptTemplate || !jsonSchemaText) {
                showResult('templateResult', 'Please fill in all required fields', 'error');
                return;
            }

            let jsonSchema;
            try {
                jsonSchema = JSON.parse(jsonSchemaText);
            } catch (error) {
                showResult('templateResult', 'Invalid JSON schema: ' + error.message, 'error');
                return;
            }

            const templateData = {
                name,
                description,
                system_prompt: systemPrompt,
                user_prompt_template: userPromptTemplate,
                json_schema: jsonSchema,
                preferred_format: preferredFormat
            };

            try {
                const response = await fetch(`/templates/${editingTemplateId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('templateResult', `Template updated successfully!\nTemplate ID: ${result.id}\nName: ${result.name}`, 'success');
                    loadTemplates();
                    cancelEdit();
                } else {
                    showResult('templateResult', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showResult('templateResult', `Error: ${error.message}`, 'error');
            }
        }

        // Cancel edit
        function cancelEdit() {
            editingTemplateId = null;
            
            // Reset form
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            document.getElementById('systemPrompt').value = '';
            document.getElementById('userPromptTemplate').value = '';
            document.getElementById('jsonSchema').value = '';
            document.getElementById('preferredFormat').value = 'text';
            
            // Switch back to create mode
            document.getElementById('templateFormTitle').textContent = 'Create New Template';
            document.getElementById('createTemplateBtn').style.display = 'inline';
            document.getElementById('updateTemplateBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Clear any results
            document.getElementById('templateResult').style.display = 'none';
        }

        // Delete template
        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/templates/${templateId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('templateResult', 'Template deleted successfully!', 'success');
                    loadTemplates();
                    
                    // If we were editing this template, cancel edit
                    if (editingTemplateId === templateId) {
                        cancelEdit();
                    }
                    
                    // If this was the selected template, clear selection
                    if (selectedTemplateId === templateId) {
                        selectedTemplateId = null;
                        document.getElementById('selectedTemplate').textContent = 'No template selected';
                        updateExtractButton();
                    }
                } else {
                    showResult('templateResult', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showResult('templateResult', `Error: ${error.message}`, 'error');
            }
        }

        // Load extractions
        async function loadExtractions() {
            try {
                const response = await fetch('/extractions');
                const extractions = await response.json();
                
                const listDiv = document.getElementById('extractionsList');
                if (extractions.length === 0) {
                    listDiv.innerHTML = '<p>No extractions found</p>';
                    return;
                }

                listDiv.innerHTML = extractions.map(extraction => 
                    `<div style="border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 4px; ${extraction.success ? 'background-color: #f8fff8;' : 'background-color: #fff8f8;'}">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <strong>Extraction ${extraction.success ? '✅' : '❌'}</strong>
                            <span style="font-size: 0.9em; color: #666;">
                                ${new Date(extraction.extraction_date || extraction.created_at).toLocaleString()}
                            </span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Artifact ID:</strong> ${extraction.artifact_id}<br>
                            <strong>Template ID:</strong> ${extraction.template_id}<br>
                            <strong>Model:</strong> ${extraction.llm_model}<br>
                            <strong>Processing Time:</strong> ${extraction.processing_time_seconds}s
                        </div>
                        ${extraction.success ? 
                            `<div style="background: #f0f0f0; padding: 10px; border-radius: 3px; margin-top: 10px;">
                                <strong>Extracted Data:</strong><br>
                                <pre style="white-space: pre-wrap; font-size: 0.9em; margin: 5px 0;">${JSON.stringify(extraction.extracted_data, null, 2)}</pre>
                            </div>` : 
                            `<div style="color: #d32f2f; margin-top: 10px;">
                                <strong>Error:</strong> ${extraction.error_message}
                            </div>`
                        }
                    </div>`
                ).join('');
            } catch (error) {
                document.getElementById('extractionsList').innerHTML = `<p>Error loading extractions: ${error.message}</p>`;
            }
        }

        // Load initial data
        window.onload = function() {
            loadArtifacts();
            loadTemplates();
            loadExtractions();
        };
    </script>
</body>
</html>